<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="en,zh-Hans,default">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="calcite,source code,">





  <link rel="alternate" href="/atom.xml" title="YouShouldKnow" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta name="description" content="Step1: 发现疑问（from csv example） Premise:  官网的tutorial看完，了解了适配csv需要编写的基本逻辑 熟悉volcano/cascades查询优化框架原理 熟悉calcite中基本的阶段(parse, validate, optimize, execute)  Tips:  以下的代码部分，数据结构相关都会在前面加上竖线，遇到读不下去不妨先看数据结构部分的">
<meta name="keywords" content="calcite,source code">
<meta property="og:type" content="article">
<meta property="og:title" content="Calcite源码阅读笔记">
<meta property="og:url" content="http://blog.youshouldknow.tech/2020/01/04/Calcite源码阅读笔记/index.html">
<meta property="og:site_name" content="YouShouldKnow">
<meta property="og:description" content="Step1: 发现疑问（from csv example） Premise:  官网的tutorial看完，了解了适配csv需要编写的基本逻辑 熟悉volcano/cascades查询优化框架原理 熟悉calcite中基本的阶段(parse, validate, optimize, execute)  Tips:  以下的代码部分，数据结构相关都会在前面加上竖线，遇到读不下去不妨先看数据结构部分的">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2020-01-14T15:00:45.188Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Calcite源码阅读笔记">
<meta name="twitter:description" content="Step1: 发现疑问（from csv example） Premise:  官网的tutorial看完，了解了适配csv需要编写的基本逻辑 熟悉volcano/cascades查询优化框架原理 熟悉calcite中基本的阶段(parse, validate, optimize, execute)  Tips:  以下的代码部分，数据结构相关都会在前面加上竖线，遇到读不下去不妨先看数据结构部分的">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.youshouldknow.tech/2020/01/04/Calcite源码阅读笔记/">





  <title>Calcite源码阅读笔记 | YouShouldKnow</title>
  














</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">YouShouldKnow</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">The world is wonderful, you should know more</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.youshouldknow.tech/2020/01/04/Calcite源码阅读笔记/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Frank Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zy_avatar.jepg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YouShouldKnow">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Calcite源码阅读笔记</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-04T23:26:12+08:00">
                2020-01-04
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/query-optimizer/" itemprop="url" rel="index">
                    <span itemprop="name">query optimizer</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Step1-发现疑问（from-csv-example）"><a href="#Step1-发现疑问（from-csv-example）" class="headerlink" title="Step1: 发现疑问（from csv example）"></a>Step1: 发现疑问（from csv example）</h1><blockquote>
<p>Premise:</p>
<ul>
<li>官网的tutorial看完，了解了适配csv需要编写的基本逻辑</li>
<li>熟悉volcano/cascades查询优化框架原理</li>
<li>熟悉calcite中基本的阶段(parse, validate, optimize, execute)</li>
</ul>
<p>Tips:</p>
<ul>
<li>以下的代码部分，数据结构相关都会在前面加上竖线，遇到读不下去不妨先看数据结构部分的定义再看逻辑代码分析。在本文写完时，会做一个总结，将所有遇到的数据结构定义以及之间的关系汇总在前面</li>
</ul>
</blockquote>
<p>从官方的CSV example的测试用例入手，我们开始学习基本的运行逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Filter that can be partly handled by CsvFilterableTable. */</span></span><br><span class="line"><span class="meta">@Test</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFilterableWhere2</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> String sql = <span class="string">"select empno, gender, name from EMPS\n"</span></span><br><span class="line">      + <span class="string">" where gender = 'F' and empno &gt; 125"</span>;</span><br><span class="line">  sql(<span class="string">"filterable-model"</span>, sql)</span><br><span class="line">      .returns(<span class="string">"EMPNO=130; GENDER=F; NAME=Alice"</span>).ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查询语句非常简单，就是从EMPS表中读取数据，使用的model也很简单：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"1.0"</span>,</span><br><span class="line">  <span class="attr">"defaultSchema"</span>: <span class="string">"SALES"</span>,</span><br><span class="line">  <span class="attr">"schemas"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"SALES"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"custom"</span>,</span><br><span class="line">      <span class="attr">"factory"</span>: <span class="string">"org.apache.calcite.adapter.csv.CsvSchemaFactory"</span>,</span><br><span class="line">      <span class="attr">"operand"</span>: &#123;</span><br><span class="line">        <span class="attr">"directory"</span>: <span class="string">"sales"</span>,</span><br><span class="line">        <span class="attr">"flavor"</span>: <span class="string">"FILTERABLE"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时，会提出几个疑问：</p>
<ol>
<li>sql字符串中的’EMPS’字符串是在什么时候以及如何转换成对应的Table的？</li>
<li>CsvSchemaFactory在其中参与了什么？串联了哪些自定义的组件？</li>
</ol>
<p>带着以上两个疑问，通过断点的方式，去查看calcite代码实现。</p>
<blockquote>
<p>Tips: 除了debug，可以测试用例中故意构造一些 Case，观察其异常栈。比如故意构造不存在字段，来看validate是如何实现的</p>
</blockquote>
<p>首先我们会注意到<strong>第一个核心类#方法</strong>：</p>
<blockquote>
<p> <code>org.apache.calcite.jdbc.CalciteMetaImpl#prepareAndExecute</code></p>
</blockquote>
<p>顾名思义，这个方法完成了所有准备阶段的工作以及最后的执行工作。要了解整个具体的流程细节是不现实的，这里我根据输入仅仅为model和sql，而model是为了sql服务的，决定跟踪sql（关系代数）在代码内的表示形式（数据结构），了解它是如何变化的，从而解决以上的两个问题。</p>
<p>准备阶段表达关系代数的数据结构：</p>
<ul>
<li><p><code>org.apache.calcite.sql.SqlNode</code></p>
</li>
<li><p><code>org.apache.calcite.rel.RelNode</code></p>
</li>
</ul>
<p>执行阶段表达关系代数的数据结构：</p>
<ul>
<li><code>org.apache.calcite.interpreter.Node</code></li>
</ul>
<h1 id="Step2-从数据结构变化来讲述实现细节："><a href="#Step2-从数据结构变化来讲述实现细节：" class="headerlink" title="Step2: 从数据结构变化来讲述实现细节："></a>Step2: 从数据结构变化来讲述实现细节：</h1><h2 id="String-gt-SqlNode"><a href="#String-gt-SqlNode" class="headerlink" title="String -&gt; SqlNode:"></a>String -&gt; SqlNode:</h2><p>通过JavaCC解析SQL，转化成AST即SqlNode</p>
<h2 id="SqlNode-gt-RelNode"><a href="#SqlNode-gt-RelNode" class="headerlink" title="SqlNode -&gt; RelNode:"></a>SqlNode -&gt; RelNode:</h2><h3 id="validate-进行AST中各个组成部分的检查"><a href="#validate-进行AST中各个组成部分的检查" class="headerlink" title="validate: 进行AST中各个组成部分的检查"></a>validate: 进行AST中各个组成部分的检查</h3><h3 id="parseQuery-进行SqlNode转化成RelNode"><a href="#parseQuery-进行SqlNode转化成RelNode" class="headerlink" title="parseQuery: 进行SqlNode转化成RelNode"></a>parseQuery: 进行SqlNode转化成RelNode</h3><h2 id="RelNode-gt-RelNode"><a href="#RelNode-gt-RelNode" class="headerlink" title="RelNode -&gt; RelNode:"></a>RelNode -&gt; RelNode:</h2><h3 id="optimize-进行RelNode的等价转换，找到最优的plan"><a href="#optimize-进行RelNode的等价转换，找到最优的plan" class="headerlink" title="optimize: 进行RelNode的等价转换，找到最优的plan"></a>optimize: 进行RelNode的等价转换，找到最优的plan</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Optimizes a query plan.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> root Root of relational expression tree</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> materializations Tables known to be populated with a given query</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> lattices Lattices</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> an equivalent optimized relational expression</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> RelRoot <span class="title">optimize</span><span class="params">(RelRoot root,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> List&lt;Materialization&gt; materializations,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> List&lt;CalciteSchema.LatticeEntry&gt; lattices)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> RelOptPlanner planner = root.rel.getCluster().getPlanner();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> DataContext dataContext = context.getDataContext();</span><br><span class="line">  planner.setExecutor(<span class="keyword">new</span> RexExecutorImpl(dataContext));</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//此处省略materialization和lattice相关的代码</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> RelTraitSet desiredTraits = getDesiredRootTraitSet(root);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> RelVisitor visitor = <span class="keyword">new</span> RelVisitor() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(RelNode node, <span class="keyword">int</span> ordinal, RelNode parent)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (node <span class="keyword">instanceof</span> TableScan) &#123;</span><br><span class="line">        <span class="keyword">final</span> RelOptCluster cluster = node.getCluster();</span><br><span class="line">        <span class="keyword">final</span> RelOptTable.ToRelContext context =</span><br><span class="line">            ViewExpanders.simpleContext(cluster);</span><br><span class="line">        <span class="keyword">final</span> RelNode r = node.getTable().toRel(context);</span><br><span class="line">        planner.registerClass(r);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">super</span>.visit(node, ordinal, parent);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  visitor.go(root.rel);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> Program program = getProgram();</span><br><span class="line">  <span class="keyword">final</span> RelNode rootRel4 = program.run(</span><br><span class="line">      planner, root.rel, desiredTraits, materializationList, latticeList);</span><br><span class="line">  <span class="keyword">if</span> (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">    LOGGER.debug(<span class="string">"Plan after physical tweaks: &#123;&#125;"</span>,</span><br><span class="line">        RelOptUtil.toString(rootRel4, SqlExplainLevel.ALL_ATTRIBUTES));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> root.withRel(rootRel4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上是optimize的代码，通过阅读，发现主要是执行<code>visitor.go</code>, <code>program.run</code>, <code>Root.withRel</code>三个方法，下面对这三个方法分别进行分析</p>
<h4 id="visitor-go"><a href="#visitor-go" class="headerlink" title="visitor.go"></a>visitor.go</h4><p>此处的访问者模式，在重写的visit方法中<u>利用super.visit访问子元素进行树的遍历</u>。下面是super.visit以及RelNode的accept方法。</p>
<blockquote>
<p>在之后会提到的HepPlanner和HepInstruction之间也有一样的visitor模式，Instruction是被访问者，最后还是在planner中定制实际的操作</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Visits a node during a traversal.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> node    Node to visit</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ordinal Ordinal of node within its parent</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> parent  Parent of the node, or null if it is the root of the</span></span><br><span class="line"><span class="comment"> *                traversal</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    RelNode node,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> ordinal,</span></span></span><br><span class="line"><span class="function"><span class="params">    RelNode parent)</span> </span>&#123;</span><br><span class="line">  node.childrenAccept(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">childrenAccept</span><span class="params">(RelVisitor visitor)</span> </span>&#123;</span><br><span class="line">  visitor.visit(input, <span class="number">0</span>, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由此也可以看出，这里遍历是为了找TableScan元素，然后注册对应的RelNode，<u><em>不过不清楚这边为啥要重新toRel生成？debug了下并没有变化，而且还少了rowType的信息</em></u>。下面是register的逻辑，主要是有新的RelNode之后，<strong>进行相关class的注册以及规则的添加到planner中</strong>。</p>
<blockquote>
<p>Q：为什么选择TableScan类型的Node来register其规则呢？</p>
<p>A：因为TableScan代表最底层的数据源，因此关于此数据源的规则都统一在此注册是最自然的。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerClass</span><span class="params">(RelNode node)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Class&lt;? extends RelNode&gt; clazz = node.getClass();</span><br><span class="line">  <span class="keyword">if</span> (classes.add(clazz)) &#123;</span><br><span class="line">    onNewClass(node); <span class="comment">//  调用node的register方法</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (RelTrait trait : node.getTraitSet()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (traits.add(trait)) &#123;</span><br><span class="line">      trait.register(<span class="keyword">this</span>); <span class="comment">// 调用trait的register方法</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="program-run"><a href="#program-run" class="headerlink" title="program.run"></a>program.run</h4><p>观察该方法的参数以及调用者，首先得知道<strong>planner, desiredTraits, program，</strong>的定义以及如何生成才能进一步了解该方法利用这些参数做了什么。materializationList, latticeList和物化和预计算相关的先不去管它，先看主要逻辑。</p>
<h5 id="Planner"><a href="#Planner" class="headerlink" title="Planner"></a>Planner</h5><h6 id="MockRelOptPlanner"><a href="#MockRelOptPlanner" class="headerlink" title="MockRelOptPlanner"></a>MockRelOptPlanner</h6><p>在阅读下面关于VolcanoPlanner相关的内容之前，这里强烈建议先看一下<code>org.apache.calcite.test.MockRelOptPlanner</code>这个mock类，了解一下实现一个planner的主要接口以及基础实现，比如：findBestExp，matchRecursive, match等等方法的实现，会发现优化器的基本步骤：</p>
<ol>
<li><code>match</code>：是否relational expression和rule的operands匹配 </li>
<li><code>rule.match(RelOptRuleCall call)</code>：虽然match，但是planner积攒了一些RelOptRuleCall，可以提前剪枝</li>
<li><code>rule.onmatch(RelOptRuleCall call)</code>：根据<code>call.rels</code>生成新的expression，通过回调<code>RelOptRuleCall.transformTo</code>注册新的expression</li>
<li>如果匹配完成，替换root或者parent的input</li>
<li>否则继续匹配子元素</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Recursively matches a rule.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> rel             Relational expression</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> parent          Parent relational expression</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ordinalInParent Ordinal of relational expression among its</span></span><br><span class="line"><span class="comment"> *                        siblings</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> whether match occurred</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">matchRecursive</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    RelNode rel,</span></span></span><br><span class="line"><span class="function"><span class="params">    RelNode parent,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> ordinalInParent)</span> </span>&#123;</span><br><span class="line">  List&lt;RelNode&gt; bindings = <span class="keyword">new</span> ArrayList&lt;RelNode&gt;();</span><br><span class="line">  <span class="keyword">if</span> (match(</span><br><span class="line">      rule.getOperand(),</span><br><span class="line">      rel,</span><br><span class="line">      bindings)) &#123;</span><br><span class="line">    MockRuleCall call =</span><br><span class="line">        <span class="keyword">new</span> MockRuleCall(</span><br><span class="line">            <span class="keyword">this</span>,</span><br><span class="line">            rule.getOperand(),</span><br><span class="line">            bindings.toArray(<span class="keyword">new</span> RelNode[<span class="number">0</span>]));</span><br><span class="line">    <span class="keyword">if</span> (rule.matches(call)) &#123;</span><br><span class="line">      rule.onMatch(call);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (transformationResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (parent == <span class="keyword">null</span>) &#123;</span><br><span class="line">      root = transformationResult;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      parent.replaceInput(ordinalInParent, transformationResult);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  List&lt;? extends RelNode&gt; children = rel.getInputs();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.size(); ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (matchRecursive(children.get(i), rel, i)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="VolcanoPlanner"><a href="#VolcanoPlanner" class="headerlink" title="VolcanoPlanner"></a>VolcanoPlanner</h6><p>下面回到正题，来看下VolcanoPlanner相关的定义和生成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a uninitialized &lt;code&gt;VolcanoPlanner&lt;/code&gt;. To fully initialize</span></span><br><span class="line"><span class="comment"> * it, the caller must register the desired set of relations, rules, and</span></span><br><span class="line"><span class="comment"> * calling conventions.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">VolcanoPlanner</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Creates a query planner and initializes it with a default set of</span></span><br><span class="line"><span class="comment"> * rules. */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> RelOptPlanner <span class="title">createPlanner</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> CalcitePrepare.Context prepareContext,</span></span></span><br><span class="line"><span class="function"><span class="params">    org.apache.calcite.plan.Context externalContext,</span></span></span><br><span class="line"><span class="function"><span class="params">    RelOptCostFactory costFactory)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (externalContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">    externalContext = Contexts.of(prepareContext.config());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">final</span> VolcanoPlanner planner =</span><br><span class="line">      <span class="keyword">new</span> VolcanoPlanner(costFactory, externalContext);</span><br><span class="line">  planner.addRelTraitDef(ConventionTraitDef.INSTANCE);</span><br><span class="line">  <span class="keyword">if</span> (CalciteSystemProperty.ENABLE_COLLATION_TRAIT.value()) &#123;</span><br><span class="line">    planner.addRelTraitDef(RelCollationTraitDef.INSTANCE);</span><br><span class="line">  &#125;</span><br><span class="line">  RelOptUtil.registerDefaultRules(planner,</span><br><span class="line">      prepareContext.config().materializationsEnabled(),</span><br><span class="line">      enableBindable);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> CalcitePrepare.SparkHandler spark = prepareContext.spark();</span><br><span class="line">  <span class="keyword">if</span> (spark.enabled()) &#123;</span><br><span class="line">    spark.registerRules(</span><br><span class="line">        <span class="keyword">new</span> SparkHandler.RuleSetBuilder() &#123;</span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRule</span><span class="params">(RelOptRule rule)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span></span></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeRule</span><span class="params">(RelOptRule rule)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span></span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  Hook.PLANNER.run(planner); <span class="comment">// allow test to add or remove rules</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> planner;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>planner的初始化，根据<u>定义的注释内容</u>主要需要填充以下三个部分：</p>
<ol>
<li>规则</li>
<li>关注的特征类别</li>
<li>关系表达式</li>
</ol>
<p>上面的<code>createPlanner</code>代码也印证了这一点，下面来看下每一个填充具体做了什么。</p>
<p>######- addRule</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addRule</span><span class="params">(RelOptRule rule)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (locked) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (ruleSet.contains(rule)) &#123;</span><br><span class="line">    <span class="comment">// Rule already exists.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">boolean</span> added = ruleSet.add(rule);</span><br><span class="line">  <span class="keyword">assert</span> added;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> String ruleName = rule.toString();</span><br><span class="line">  <span class="keyword">if</span> (ruleNames.put(ruleName, rule.getClass())) &#123;</span><br><span class="line">    Set&lt;Class&gt; x = ruleNames.get(ruleName);</span><br><span class="line">    <span class="keyword">if</span> (x.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Rule description '"</span> + ruleName</span><br><span class="line">          + <span class="string">"' is not unique; classes: "</span> + x);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  mapRuleDescription(rule);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Each of this rule's operands is an 'entry point' for a rule call.</span></span><br><span class="line">  <span class="comment">// Register each operand against all concrete sub-classes that could match</span></span><br><span class="line">  <span class="comment">// it.</span></span><br><span class="line">  <span class="keyword">for</span> (RelOptRuleOperand operand : rule.getOperands()) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;? extends RelNode&gt; subClass</span><br><span class="line">        : subClasses(operand.getMatchedClass())) &#123;</span><br><span class="line">      classOperands.put(subClass, operand);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If this is a converter rule, check that it operates on one of the</span></span><br><span class="line">  <span class="comment">// kinds of trait we are interested in, and if so, register the rule</span></span><br><span class="line">  <span class="comment">// with the trait.</span></span><br><span class="line">  <span class="keyword">if</span> (rule <span class="keyword">instanceof</span> ConverterRule) &#123;</span><br><span class="line">    ConverterRule converterRule = (ConverterRule) rule;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> RelTrait ruleTrait = converterRule.getInTrait();</span><br><span class="line">    <span class="keyword">final</span> RelTraitDef ruleTraitDef = ruleTrait.getTraitDef();</span><br><span class="line">    <span class="keyword">if</span> (traitDefs.contains(ruleTraitDef)) &#123;</span><br><span class="line">      ruleTraitDef.registerConverterRule(<span class="keyword">this</span>, converterRule);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里在添加规则时，最后会把<strong>convention之间的转换关系</strong>注册到对应的RelTraitDef（ConventionTraitDef）中。</p>
<h6 id="setRoot"><a href="#setRoot" class="headerlink" title="- setRoot"></a>- setRoot</h6><h6 id="changeTraits"><a href="#changeTraits" class="headerlink" title="- changeTraits"></a>- changeTraits</h6><p>###### </p>
<h5 id="desiredTraits"><a href="#desiredTraits" class="headerlink" title="desiredTraits"></a>desiredTraits</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> RelTraitSet <span class="title">getDesiredRootTraitSet</span><span class="params">(RelRoot root)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Make sure non-CallingConvention traits, if any, are preserved</span></span><br><span class="line">  <span class="keyword">return</span> root.rel.getTraitSet()</span><br><span class="line">      .replace(resultConvention)</span><br><span class="line">      .replace(root.collation)</span><br><span class="line">      .simplify();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>期望的输出的特征，主要是两个在planner中添加关注的特征的具体实现: Convention &amp;&amp; Collation，这两者在优化时属于关系表达式的<strong>补充信息</strong>，在优化时会不仅会考虑cost，也会结合补充信息，比如排序以及调用约定。</p>
<h5 id="Program"><a href="#Program" class="headerlink" title="Program"></a>Program</h5><p>首先需要看下Program的定义和生成</p>
<blockquote>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt;   <span class="comment">/**</span></span><br><span class="line"><span class="comment">&gt;    * Program that transforms a relational expression into another relational</span></span><br><span class="line"><span class="comment">&gt;    * expression.</span></span><br><span class="line"><span class="comment">&gt;    *</span></span><br><span class="line"><span class="comment">&gt;    * &lt;p&gt;A planner is a sequence of programs, each of which is sometimes called</span></span><br><span class="line"><span class="comment">&gt;    * a "phase".</span></span><br><span class="line"><span class="comment">&gt;    * The most tyßpical program is an invocation of the volcano planner with a</span></span><br><span class="line"><span class="comment">&gt;    * particular &#123;<span class="doctag">@link</span> org.apache.calcite.tools.RuleSet&#125;.&lt;/p&gt;</span></span><br><span class="line"><span class="comment">&gt;    */</span></span><br><span class="line">&gt;   <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Program</span> </span>&#123;</span><br><span class="line">&gt;     <span class="function">RelNode <span class="title">run</span><span class="params">(RelOptPlanner planner, RelNode rel,</span></span></span><br><span class="line"><span class="function"><span class="params">&gt;         RelTraitSet requiredOutputTraits,</span></span></span><br><span class="line"><span class="function"><span class="params">&gt;         List&lt;RelOptMaterialization&gt; materializations,</span></span></span><br><span class="line"><span class="function"><span class="params">&gt;         List&lt;RelOptLattice&gt; lattices)</span></span>;</span><br><span class="line">&gt;   &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>Program的定义可知，<strong>program</strong>是负责转换<strong>关系表达式</strong>的，而<strong>planner</strong>就是由多个program <strong>sequence</strong>组成的，每一个program可以叫做一个<strong>phase</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Program <span class="title">getProgram</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Allow a test to override the default program.</span></span><br><span class="line">  <span class="keyword">final</span> Holder&lt;Program&gt; holder = Holder.of(<span class="keyword">null</span>);</span><br><span class="line">  Hook.PROGRAM.run(holder); <span class="comment">// 运行钩子</span></span><br><span class="line">  <span class="keyword">if</span> (holder.get() != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> holder.get();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Programs.standard();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以稍微看一下<strong>Holder</strong>和<strong>Hook</strong>的作用，Holder可以保存对象，用来实现参数的传递；Hook则是在query prepare过程中不同阶段的钩子，是enum类型的，可以添加Consumer方法来添加一些测试或者debug逻辑。</p>
<p>我们的例子里这两个没有影响，所需要看的就是<code>Programs.standard()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Returns the standard program with user metadata provider. */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Program <span class="title">standard</span><span class="params">(RelMetadataProvider metadataProvider)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Program program1 =</span><br><span class="line">      (planner, rel, requiredOutputTraits, materializations, lattices) -&gt; &#123;</span><br><span class="line">        planner.setRoot(rel);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (RelOptMaterialization materialization : materializations) &#123;</span><br><span class="line">          planner.addMaterialization(materialization);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (RelOptLattice lattice : lattices) &#123;</span><br><span class="line">          planner.addLattice(lattice);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> RelNode rootRel2 =</span><br><span class="line">            rel.getTraitSet().equals(requiredOutputTraits)</span><br><span class="line">                ? rel</span><br><span class="line">                : planner.changeTraits(rel, requiredOutputTraits);</span><br><span class="line">        <span class="keyword">assert</span> rootRel2 != <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        planner.setRoot(rootRel2);</span><br><span class="line">        <span class="keyword">final</span> RelOptPlanner planner2 = planner.chooseDelegate();</span><br><span class="line">        <span class="keyword">final</span> RelNode rootRel3 = planner2.findBestExp();</span><br><span class="line">        <span class="keyword">assert</span> rootRel3 != <span class="keyword">null</span> : <span class="string">"could not implement exp"</span>;</span><br><span class="line">        <span class="keyword">return</span> rootRel3;</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> sequence(subQuery(metadataProvider),</span><br><span class="line">      <span class="keyword">new</span> DecorrelateProgram(),</span><br><span class="line">      <span class="keyword">new</span> TrimFieldsProgram(),</span><br><span class="line">      program1,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Second planner pass to do physical "tweaks". This the first time</span></span><br><span class="line">      <span class="comment">// that EnumerableCalcRel is introduced.</span></span><br><span class="line">      calc(metadataProvider));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到最终是返回了一个sequence里面包含了五个不同的program作为最终的program。其中最重要的则是在<code>standard</code>方法中定义的program1，完成了主要的优化工作。下面就着重看下program1具体做了什么。</p>
<p>这里可以看到主要是在操作planner，主要有以下几个步骤：</p>
<ol>
<li><code>planner.setRoot</code></li>
<li><code>planner.changeTraits</code></li>
<li><code>planner.findBestExp</code></li>
</ol>
<p>其中1, 2 在前面介绍VolcanoPlanner定义和生成部分就讲过了，这里主要讲下<code>planner.findBestExp</code>的运行原理。</p>
<h6 id="findBestExp"><a href="#findBestExp" class="headerlink" title="findBestExp"></a>findBestExp</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RelNode <span class="title">findBestExp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ensureRootConverters(); <span class="comment">// 确保根节点SubSet之间由该Set下的其他SubSet convert得到</span></span><br><span class="line">  registerMaterializations();<span class="comment">// 注册物化相关的RelNode</span></span><br><span class="line">  <span class="keyword">int</span> cumulativeTicks = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (VolcanoPlannerPhase phase : VolcanoPlannerPhase.values()) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    	初始化SubSet的Importance,进而更新RuleMatch的Importance</span></span><br><span class="line"><span class="comment">    	Double importance = Math.pow(0.9, (double) depth);</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    setInitialImportance();</span><br><span class="line">    RelOptCost targetCost = costFactory.makeHugeCost();</span><br><span class="line">    <span class="keyword">int</span> tick = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> firstFiniteTick = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> splitCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> giveUpTick = Integer.MAX_VALUE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">      ++tick;</span><br><span class="line">      ++cumulativeTicks;</span><br><span class="line">      <span class="keyword">if</span> (root.bestCost.isLe(targetCost)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (firstFiniteTick &lt; <span class="number">0</span>) &#123;</span><br><span class="line">          firstFiniteTick = cumulativeTicks;</span><br><span class="line"></span><br><span class="line">          clearImportanceBoost();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ambitious) &#123;</span><br><span class="line">          <span class="comment">// Choose a slightly more ambitious target cost, and</span></span><br><span class="line">          <span class="comment">// try again. If it took us 1000 iterations to find our</span></span><br><span class="line">          <span class="comment">// first finite plan, give ourselves another 100</span></span><br><span class="line">          <span class="comment">// iterations to reduce the cost by 10%.</span></span><br><span class="line">          targetCost = root.bestCost.multiplyBy(<span class="number">0.9</span>);</span><br><span class="line">          ++splitCount;</span><br><span class="line">          <span class="keyword">if</span> (impatient) &#123;</span><br><span class="line">            <span class="keyword">if</span> (firstFiniteTick &lt; <span class="number">10</span>) &#123;</span><br><span class="line">              <span class="comment">// It's possible pre-processing can create</span></span><br><span class="line">              <span class="comment">// an implementable plan -- give us some time</span></span><br><span class="line">              <span class="comment">// to actually optimize it.</span></span><br><span class="line">              giveUpTick = cumulativeTicks + <span class="number">25</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              giveUpTick =</span><br><span class="line">                  cumulativeTicks</span><br><span class="line">                      + Math.max(firstFiniteTick / <span class="number">10</span>, <span class="number">25</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cumulativeTicks &gt; giveUpTick) &#123;</span><br><span class="line">        <span class="comment">// We haven't made progress recently. Take the current best.</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (root.bestCost.isInfinite() &amp;&amp; ((tick % <span class="number">10</span>) == <span class="number">0</span>)) &#123;</span><br><span class="line">        injectImportanceBoost();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      LOGGER.debug(<span class="string">"PLANNER = &#123;&#125;; TICK = &#123;&#125;/&#123;&#125;; PHASE = &#123;&#125;; COST = &#123;&#125;"</span>,</span><br><span class="line">          <span class="keyword">this</span>, cumulativeTicks, tick, phase.toString(), root.bestCost);</span><br><span class="line"></span><br><span class="line">      VolcanoRuleMatch match = ruleQueue.popMatch(phase);</span><br><span class="line">      <span class="keyword">if</span> (match == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">assert</span> match.getRule().matches(match);</span><br><span class="line">      match.onMatch();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// The root may have been merged with another</span></span><br><span class="line">      <span class="comment">// subset. Find the new root subset.</span></span><br><span class="line">      root = canonize(root);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ruleQueue.phaseCompleted(phase);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (LOGGER.isTraceEnabled()) &#123;</span><br><span class="line">    StringWriter sw = <span class="keyword">new</span> StringWriter();</span><br><span class="line">    <span class="keyword">final</span> PrintWriter pw = <span class="keyword">new</span> PrintWriter(sw);</span><br><span class="line">    dump(pw);</span><br><span class="line">    pw.flush();</span><br><span class="line">    LOGGER.trace(sw.toString());</span><br><span class="line">  &#125;</span><br><span class="line">  RelNode cheapest = root.buildCheapestPlan(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">if</span> (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">    LOGGER.debug(</span><br><span class="line">        <span class="string">"Cheapest plan:\n&#123;&#125;"</span>, RelOptUtil.toString(cheapest, SqlExplainLevel.ALL_ATTRIBUTES));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!provenanceMap.isEmpty()) &#123;</span><br><span class="line">      LOGGER.debug(<span class="string">"Provenance:\n&#123;&#125;"</span>, provenance(cheapest));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cheapest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码我给了详细的注释，总结如下：</p>
<ol>
<li><p>填充根节点AbstractConverter(if needed)</p>
</li>
<li><p>注册物化的RelNode</p>
</li>
<li><p>在不同的phase下</p>
<ol>
<li><p>初始化Importance</p>
</li>
<li><p>进入迭代VolcanoRuleMatch</p>
<ol>
<li><p>判断是否退出</p>
<ol>
<li><p>ruleMatch为空了</p>
</li>
<li><p>For ambitious planners:  近期没有提升</p>
<p>近期的迭代次数是指： (specifically within a number of iterations that is 10% of the number of iterations necessary to first reach an implementable plan or 25 iterations whichever is larger).</p>
<p>提升是指：低于之前最优cost的90%</p>
</li>
<li><p>For non-ambitious planners: 找到一个Implement plan</p>
<blockquote>
<p>Furthermore, after every 10 iterations without an implementable plan, RelSubSets that contain only logical RelNodes are given an importance boost via injectImportanceBoost(). Once an implementable plan is found, the artificially raised importance values are cleared (see clearImportanceBoost()).</p>
</blockquote>
</li>
</ol>
</li>
<li><p>匹配规则</p>
<p>// todo</p>
</li>
<li><p>canonize根节点</p>
</li>
</ol>
</li>
</ol>
</li>
<li><p>root.buildCheapestPlan</p>
</li>
</ol>
<h4 id="Root-withRel"><a href="#Root-withRel" class="headerlink" title="Root.withRel"></a>Root.withRel</h4><h4 id="optimize-summary"><a href="#optimize-summary" class="headerlink" title="optimize summary:"></a>optimize summary:</h4><p>本质上，优化做了两件事：</p>
<ol>
<li>填充planner<ul>
<li>createPlanner: 初始化planner，填充默认规则以及traitDef</li>
<li>visitor.go: 填充数据源相关的rule</li>
<li>setRoot: <ul>
<li>将RelNode转化成RelSubSet</li>
<li>匹配规则</li>
</ul>
</li>
<li>changeTraits: </li>
</ul>
</li>
<li>执行findBestExp</li>
</ol>
<h2 id="RelNode-gt-Bindable"><a href="#RelNode-gt-Bindable" class="headerlink" title="RelNode -&gt; Bindable:"></a>RelNode -&gt; Bindable:</h2><ul>
<li><p><code>Bindable</code></p>
<p>最终返回的对象；可以和Context绑定后返回Enumerable over rows；</p>
</li>
<li><p><code>EnumerableInterpretable</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bindable = EnumerableInterpretable.toBindable(internalParameters,</span><br><span class="line">              context.spark(), enumerable, prefer);</span><br></pre></td></tr></table></figure>
<p>在这里主要用<a href="https://github.com/apache/calcite/blob/e226ae49f987dde3a64b69cd474152d9adc7c38c/core/src/main/java/org/apache/calcite/adapter/enumerable/EnumerableInterpretable.java#L105" target="_blank" rel="noopener">toBindable</a>方法来返回<code>Bindable</code>对象的</p>
<p>而<code>toBindable</code>方法中最重要的是通过<code>EnumerableRelImplementor</code>对象的<a href="https://github.com/apache/calcite/blob/b8bdfb074be12f90c98f9f1fa2af8cf46f2d36f1/core/src/main/java/org/apache/calcite/adapter/enumerable/EnumerableRelImplementor.java#L102" target="_blank" rel="noopener">implementRoot</a>方法生成<code>ClassDeclaration</code></p>
<p>进而通过<a href="https://github.com/apache/calcite/blob/e226ae49f987dde3a64b69cd474152d9adc7c38c/core/src/main/java/org/apache/calcite/adapter/enumerable/EnumerableInterpretable.java#L133" target="_blank" rel="noopener">getBindable</a>方法利用janino生成Bindable实例；</p>
</li>
<li><p><code>RelImplementor</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ClassDeclaration expr = relImplementor.implementRoot(rel, prefer);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>  This is a marker interface for a callback used to <strong>convert a tree of relational expressions into a plan</strong>. <u>Calling conventions typically have their own protocol for walking over a tree, and correspondingly have their own implementors</u></p>
<p>  因为根节点默认是Enumerable Convention，因此必然会经历<code>EnumerableRelImplementor</code>，而在测试中，由于使用了jdbc.clickhouse，因此还会用到<code>JdbcImplementor</code></p>
<ul>
<li><p>—&gt;<code>EnumerableRelImplementor</code>：Subclass of org.apache.calcite.plan.RelImplementor for relational operators of <u>EnumerableConvention calling convention</u>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ClassDeclaration <span class="title">implementRoot</span><span class="params">(EnumerableRel rootRel,</span></span></span><br><span class="line"><span class="function"><span class="params">    EnumerableRel.Prefer prefer)</span> </span>&#123;</span><br><span class="line">  EnumerableRel.Result result = rootRel.implement(<span class="keyword">this</span>, prefer);</span><br><span class="line">  <span class="keyword">switch</span> (prefer) &#123;</span><br><span class="line">  <span class="keyword">case</span> ARRAY:</span><br><span class="line">    <span class="keyword">if</span> (result.physType.getFormat() == JavaRowFormat.ARRAY</span><br><span class="line">        &amp;&amp; rootRel.getRowType().getFieldCount() == <span class="number">1</span>) &#123;</span><br><span class="line">      BlockBuilder bb = <span class="keyword">new</span> BlockBuilder();</span><br><span class="line">      Expression e = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">for</span> (Statement statement : result.block.statements) &#123;</span><br><span class="line">        <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> GotoStatement) &#123;</span><br><span class="line">          e = bb.append(<span class="string">"v"</span>, ((GotoStatement) statement).expression);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          bb.add(statement);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">        bb.add(</span><br><span class="line">            Expressions.return_(<span class="keyword">null</span>,</span><br><span class="line">                Expressions.call(<span class="keyword">null</span>, BuiltInMethod.SLICE0.method, e)));</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="keyword">new</span> EnumerableRel.Result(bb.toBlock(), result.physType,</span><br><span class="line">          JavaRowFormat.SCALAR);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> List&lt;MemberDeclaration&gt; memberDeclarations = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">new</span> TypeRegistrar(memberDeclarations).go(result);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This creates the following code</span></span><br><span class="line">  <span class="comment">// final Integer v1stashed = (Integer) root.get("v1stashed")</span></span><br><span class="line">  <span class="comment">// It is convenient for passing non-literal "compile-time" constants</span></span><br><span class="line">  <span class="keyword">final</span> Collection&lt;Statement&gt; stashed =</span><br><span class="line">      Collections2.transform(stashedParameters.values(),</span><br><span class="line">          input -&gt; Expressions.declare(Modifier.FINAL, input,</span><br><span class="line">              Expressions.convert_(</span><br><span class="line">                  Expressions.call(DataContext.ROOT,</span><br><span class="line">                      BuiltInMethod.DATA_CONTEXT_GET.method,</span><br><span class="line">                      Expressions.constant(input.name)),</span><br><span class="line">                  input.type)));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> BlockStatement block = Expressions.block(</span><br><span class="line">      Iterables.concat(</span><br><span class="line">          stashed,</span><br><span class="line">          result.block.statements));</span><br><span class="line">  memberDeclarations.add(</span><br><span class="line">      Expressions.methodDecl(</span><br><span class="line">          Modifier.PUBLIC,</span><br><span class="line">          Enumerable.class,</span><br><span class="line">          BuiltInMethod.BINDABLE_BIND.method.getName(),</span><br><span class="line">          Expressions.list(DataContext.ROOT),</span><br><span class="line">          block));</span><br><span class="line">  memberDeclarations.add(</span><br><span class="line">      Expressions.methodDecl(Modifier.PUBLIC, Class.class,</span><br><span class="line">          BuiltInMethod.TYPED_GET_ELEMENT_TYPE.method.getName(),</span><br><span class="line">          ImmutableList.of(),</span><br><span class="line">          Blocks.toFunctionBlock(</span><br><span class="line">              Expressions.return_(<span class="keyword">null</span>,</span><br><span class="line">                  Expressions.constant(result.physType.getJavaRowType())))));</span><br><span class="line">  <span class="keyword">return</span> Expressions.classDecl(Modifier.PUBLIC,</span><br><span class="line">      <span class="string">"Baz"</span>,</span><br><span class="line">      <span class="keyword">null</span>,</span><br><span class="line">      Collections.singletonList(Bindable.class),</span><br><span class="line">      memberDeclarations);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>- 调用**EnumerableRel#implement**生成EnumerableRel.Result（用来生成plan执行的java代码）
- 生成**ClassDeclaration**的实例，将两个默认的成员方法填充（通过第一步生成的Result得到）;
</code></pre><ul>
<li>—&gt;<code>JdbcImplementor</code>: 继承<code>RelToSqlConverter</code>，主要用来获取RelNode对应的SqlNode，然后通过SqlNode得到对应的sql语句。返回的sql语句一般用作填充进上层的Converter的implement方法产生的java代码中。</li>
</ul>
<blockquote>
<p>值得一提的是，最终ResultSet的next()方法，本质上是调用了Cursor的next()方法，而Cursor的next()方法，本质上在调用linq4j包下的<a href="https://github.com/apache/calcite/blob/295ab13e8338bdd0e0c29e051907371c9b2929aa/linq4j/src/main/java/org/apache/calcite/linq4j/Linq4j.java#L668" target="_blank" rel="noopener">EnumeratorIterator</a>的hasNext()和next()方法，且在初始化Iterator的时候会先调用next()方法来确定是否hasNext，即hasNext()是由next()方法确定的。最终next()方法是调用Bindable返回的Enumerable对象产生的Enumerator对象的moveNext方法</p>
<p>在prepareAndExecute方法会先execute找到第一个存在的行，之后返回，进行ResultSet遍历</p>
</blockquote>
<h1 id="Step3-解答疑问（from-step-1）"><a href="#Step3-解答疑问（from-step-1）" class="headerlink" title="Step3: 解答疑问（from step 1）"></a>Step3: 解答疑问（from step 1）</h1><p>Q1:</p>
<p>通过构造不存在表明，通过异常栈的分析可以得知，在<code>IdentifierNamespace#resolveImpl</code>时抛出异常，通过阅读代码得知，是在多次<code>parentScope.resolveTable</code>失败后确认无法匹配，从而在validate过程中就对表是否存在进行了判断，如果存在<strong>得到对应的<code>RelOptTable</code></strong></p>
<p>在SqlNode -&gt; RelNode的convert中也会先生成<strong><code>RelOptTable</code></strong></p>
<p>通过对<code>CsvTableScan</code>的构造函数debug，在sqlToRelConvert的时候会<strong>构造scan表所对应的<code>RelNode</code></strong></p>
<p>Q2:</p>
<p>通过Q1的分析，以及对相关类的debug</p>
<ul>
<li>CsvSchemaFactory是在validate生成<strong><code>RelOptTable</code></strong>的时候调用，生成了Schema下存在的tables</li>
<li>在convert的时候直接复用填充进<code>RelOptTable</code></li>
<li>在<code>RelOptTable</code>中根据填充的table实现的接口，如（TranslatableTable, ScannableTable）来确定其如何转化成<code>RelNode</code></li>
</ul>
<h1 id="Step4-如何在此基础上实现平台间数据迁移"><a href="#Step4-如何在此基础上实现平台间数据迁移" class="headerlink" title="Step4: 如何在此基础上实现平台间数据迁移"></a>Step4: 如何在此基础上实现平台间数据迁移</h1><p>要解决这个问题需要弄清楚两个问题：</p>
<p>Q1: 确定不同数据源即数据在不同的Convention中是如何添加Converter进行Convention的转换的?</p>
<p>Q2: 添加完Converter后，Converter是如何执行的，是否可以集成在Calcite中？</p>
<p>下面针对这两个问题，进行代码debug ，由于此处需要Converter，因此此处用calcite的jdbc adapter访问clickhouse来构造测试用例。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> project_name, project_name <span class="keyword">FROM</span> clickhouse.em_projects <span class="keyword">as</span> p;</span><br></pre></td></tr></table></figure>
<p>Q1: </p>
<p>通过debug optimze的过程中plan的变化，得知plan是在changeTraits完之后setRoot时候添加上Converter的，此时是一个AbstractConverter（待implement）</p>
<p>通过debug findBestExp的过程中整个memo的变化（规则匹配），发现ExpandConversionRule是用来implement AbstractConverter的规则，<strong>这个规则会将AbstractConverter转化为一个converter链</strong>，从而得到目标的convention。通过之前建立<strong>转化图的传递闭包</strong>(见之前addRule函数的介绍)，这里会选择最短的链。</p>
<blockquote>
<p>如果target subset已经存在implementation，则不会触发</p>
<p>如果source subset是abstract的，那么会标记该subset，一旦有non-abstract的rel exp添加进去就触发转换</p>
</blockquote>
<p>因此这里最先匹配该规则后由于input/source 的subset是abstract的，因此无效。继而匹配其他规则，最终是JdbcToEnumerableConverter, JdbcProjectRule得到了最优的plan。</p>
<p>Q2：</p>
<p>由Step2中关于RelNode-&gt;Bindable的内容可以得知，将RelNode转化为真正可以执行的plan，需要<code>RelImplementor</code>得到Java代码后编译执行。</p>
<p>首先先看下目标生成的java代码长什么样子:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> org.apache.calcite.linq4j.<span class="function">Enumerable <span class="title">bind</span><span class="params">(<span class="keyword">final</span> org.apache.calcite.DataContext root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> org.apache.calcite.linq4j.function.Function1 rowBuilderFactory = <span class="keyword">new</span> org.apache.calcite.linq4j.function.Function1() &#123;</span><br><span class="line">        <span class="keyword">public</span> org.apache.calcite.linq4j.function.<span class="function">Function0 <span class="title">apply</span><span class="params">(<span class="keyword">final</span> java.sql.ResultSet resultSet)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> org.apache.calcite.linq4j.function.Function0() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> Object <span class="title">apply</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">final</span> Object[] values = <span class="keyword">new</span> Object[<span class="number">2</span>];</span><br><span class="line">                        values[<span class="number">0</span>] = resultSet.getObject(<span class="number">1</span>);</span><br><span class="line">                        values[<span class="number">1</span>] = resultSet.getObject(<span class="number">2</span>);</span><br><span class="line">                        <span class="keyword">return</span> values;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (java.sql.SQLException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                                e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">                    ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">apply</span><span class="params">(<span class="keyword">final</span> Object resultSet)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> apply(</span><br><span class="line">                    (java.sql.ResultSet) resultSet);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">            ;</span><br><span class="line">    <span class="keyword">final</span> org.apache.calcite.runtime.ResultSetEnumerable enumerable = org.apache.calcite.runtime.ResultSetEnumerable.of((javax.sql.DataSource) root.getRootSchema().getSubSchema(<span class="string">"clickhouse"</span>).unwrap(javax.sql.DataSource.class), <span class="string">"SELECT `project_name`, `project_name` AS `project_name0`\nFROM `default`.`em_projects`"</span>, rowBuilderFactory);</span><br><span class="line">    enumerable.setTimeout(root);</span><br><span class="line">    <span class="keyword">return</span> enumerable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Class <span class="title">getElementType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> java.lang.Object[].class;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以发现最终返回的是<code>ResultSetEnumerable</code>对象，其<u>本质上是将jdbc查询clickhouse之后返回的resultSet封装到Eumerator中进行迭代</u></p>
<p>而具体生成此处代码的逻辑，则在<code>JdbcToEnumerableConverter#implement</code>中，构建了这样的一个Expression Tree</p>
<blockquote>
<p>由此可见实现Converter，最重要就是实现对应Converter的Implement代码来完成Expression Tree（generating java code）的生成</p>
</blockquote>
<h1 id="Step5-如何做到跨平台的Join-Reorder"><a href="#Step5-如何做到跨平台的Join-Reorder" class="headerlink" title="Step5: 如何做到跨平台的Join Reorder"></a>Step5: 如何做到跨平台的Join Reorder</h1><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference:"></a>Reference:</h1><ol>
<li>官网教程:  <a href="https://calcite.apache.org/docs/index.html" target="_blank" rel="noopener">https://calcite.apache.org/docs/index.html</a></li>
<li>Calcite简介：<a href="https://www.slideshare.net/JordanHalterman/introduction-to-apache-calcite" target="_blank" rel="noopener">https://www.slideshare.net/JordanHalterman/introduction-to-apache-calcite</a></li>
<li>Cascades / Volcano: <a href="https://15721.courses.cs.cmu.edu/spring2019/papers/22-optimizer1/xu-columbia-thesis1998.pdf" target="_blank" rel="noopener">https://15721.courses.cs.cmu.edu/spring2019/papers/22-optimizer1/xu-columbia-thesis1998.pdf</a></li>
<li>数据库CMU课程：<a href="https://15721.courses.cs.cmu.edu/spring2019/schedule.html" target="_blank" rel="noopener">https://15721.courses.cs.cmu.edu/spring2019/schedule.html</a></li>
</ol>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:</strong>
    Frank Zhang
  </li>
  <li class="post-copyright-link">
    <strong>Post link:</strong>
    <a href="http://blog.youshouldknow.tech/2020/01/04/Calcite源码阅读笔记/" title="Calcite源码阅读笔记">http://blog.youshouldknow.tech/2020/01/04/Calcite源码阅读笔记/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice: </strong>
    All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> unless stating additionally.
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/calcite/" rel="tag"># calcite</a>
          
            <a href="/tags/source-code/" rel="tag"># source code</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/09/25/2019秋招总结和自省/" rel="next" title="2019秋招总结和自省">
                <i class="fa fa-chevron-left"></i> 2019秋招总结和自省
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/zy_avatar.jepg" alt="Frank Zhang">
          <p class="site-author-name" itemprop="name">Frank Zhang</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/pilife" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/zhang-yi-14-85-5/activities" target="_blank" title="ZhiHu">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      ZhiHu
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Step1-发现疑问（from-csv-example）"><span class="nav-number">1.</span> <span class="nav-text">Step1: 发现疑问（from csv example）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Step2-从数据结构变化来讲述实现细节："><span class="nav-number">2.</span> <span class="nav-text">Step2: 从数据结构变化来讲述实现细节：</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#String-gt-SqlNode"><span class="nav-number">2.1.</span> <span class="nav-text">String -&gt; SqlNode:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SqlNode-gt-RelNode"><span class="nav-number">2.2.</span> <span class="nav-text">SqlNode -&gt; RelNode:</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#validate-进行AST中各个组成部分的检查"><span class="nav-number">2.2.1.</span> <span class="nav-text">validate: 进行AST中各个组成部分的检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#parseQuery-进行SqlNode转化成RelNode"><span class="nav-number">2.2.2.</span> <span class="nav-text">parseQuery: 进行SqlNode转化成RelNode</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RelNode-gt-RelNode"><span class="nav-number">2.3.</span> <span class="nav-text">RelNode -&gt; RelNode:</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#optimize-进行RelNode的等价转换，找到最优的plan"><span class="nav-number">2.3.1.</span> <span class="nav-text">optimize: 进行RelNode的等价转换，找到最优的plan</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#visitor-go"><span class="nav-number">2.3.1.1.</span> <span class="nav-text">visitor.go</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#program-run"><span class="nav-number">2.3.1.2.</span> <span class="nav-text">program.run</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Planner"><span class="nav-number">2.3.1.2.1.</span> <span class="nav-text">Planner</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#MockRelOptPlanner"><span class="nav-number">2.3.1.2.1.1.</span> <span class="nav-text">MockRelOptPlanner</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#VolcanoPlanner"><span class="nav-number">2.3.1.2.1.2.</span> <span class="nav-text">VolcanoPlanner</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#setRoot"><span class="nav-number">2.3.1.2.1.3.</span> <span class="nav-text">- setRoot</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#changeTraits"><span class="nav-number">2.3.1.2.1.4.</span> <span class="nav-text">- changeTraits</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#desiredTraits"><span class="nav-number">2.3.1.2.2.</span> <span class="nav-text">desiredTraits</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Program"><span class="nav-number">2.3.1.2.3.</span> <span class="nav-text">Program</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#findBestExp"><span class="nav-number">2.3.1.2.3.1.</span> <span class="nav-text">findBestExp</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Root-withRel"><span class="nav-number">2.3.1.3.</span> <span class="nav-text">Root.withRel</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#optimize-summary"><span class="nav-number">2.3.1.4.</span> <span class="nav-text">optimize summary:</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RelNode-gt-Bindable"><span class="nav-number">2.4.</span> <span class="nav-text">RelNode -&gt; Bindable:</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Step3-解答疑问（from-step-1）"><span class="nav-number">3.</span> <span class="nav-text">Step3: 解答疑问（from step 1）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Step4-如何在此基础上实现平台间数据迁移"><span class="nav-number">4.</span> <span class="nav-text">Step4: 如何在此基础上实现平台间数据迁移</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Step5-如何做到跨平台的Join-Reorder"><span class="nav-number">5.</span> <span class="nav-text">Step5: 如何做到跨平台的Join Reorder</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Reference"><span class="nav-number">6.</span> <span class="nav-text">Reference:</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2019 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Frank Zhang</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
