---
title: 如何计算分布式系统的可靠性
date: 2021-05-10 16:48:46
tags:
- 可靠性
- 概率论
categories:
- 概率论应用
mathjax: true
excerpt: 如果你熟悉各类云上存储产品，一定经常看到诸如数据可靠性11个9之类的描述，但是你可能不清楚这代表的具体含义，其单位是什么？是怎么计算出来的？本文将对分布式系统的可靠性计算作简要描述。
---

## 符号表

本文所有用到以下符号处语义均相同

$K$：故障磁盘数量

$N$：集群磁盘总数量

$R$：副本数

$S$：副本大小

$M$：集群总数据量

## 基础知识

泊松分布：描述**单位时间内**随机事件发生的**次数**的概率分布
$$
P(X=k)=\frac{e^{-\lambda}\lambda^k}{k!}
$$

## 问题建模

### 问题定义

简略描述：分布式存储系统年失效率

详细描述：以硬盘为存储数据的基本物理单位，一年时间内，硬盘故障导致数据丢失的概率

### 问题拆解

1. 单个硬盘单位时间$t$故障概率 $\lambda$
2. $K$个硬盘一段时间`T`内故障概率 $P_a(T,K)$
3. 损坏的$K$个硬盘恰好造成数据丢失的概率 $P_b(K)$
4. $T$时间内，硬盘故障导致数据丢失的概率 $P_c(T)$

### 问题求解

####  $\lambda$

 $\lambda$通过统计即可得到，设 $t$ 为1小时，根据google的统计，磁盘的年失败率(AFR: Fnnualized Failure Rate)如下图所示，取平均值4来进行估算，那么$\lambda$是0.0004566

<img src="https://blog-1251491272.cos.ap-beijing.myqcloud.com/uPic/afr_age.png" style="zoom: 33%;" />

#### $P_a(T,K)$

通过 $\lambda$以及泊松分布的公式，可以计算得到$P_a(T,K)$

#### $P_b(K)$

通过数据复制方式和副本放置策略，可以建模得到 $P_b(K)$，数据复制方式分为多副本和EC，副本放置策略可以是固定位置放置，可以是随机不重复放置

> Q：关于随机不重复放置，是否能保证有足够的放置策略让副本放置不重复呢？
>
> A：随着集群规模增大，可容纳数据量呈线性增长，放置策略数量呈幂增长，因此可以认为放置策略远远大于需要放置的数据量（数据复制的基本单位是副本）
>
> 以下证明：
>
> 假设一个磁盘中副本数量为$C$，副本/EC数为$R$，集群中磁盘的数量为$x$
>
> 可容纳数据量：$x * C / R$
>
> 放置策略数量：$(x/R)^R$
>
> ![img](https://blog-1251491272.cos.ap-beijing.myqcloud.com/uPic/300px-Exponential.svg-20210510195955279.png)

#### $P_c(T)$

通过$P_a(T,K)*P_b(K)$可以得到 $T$ 时间内损坏磁盘数量为 $K$ 时，数据丢失的概率。将所有可能的 $K$ 计算得到的概率相加即可得到$P_c(T)$，计算公式如下：
$$
P_c(T) = \sum P_a(T,K)*P_b(K) \\
K \ge min\ number\ of\ replica\ to\ be\ removed
$$


## 细节补充

通过对问题进行建模，发现唯一不确定的地方就是$P_b(K)$的计算，其计算的基本思想如下：

$P_b(K)$：磁盘数为$N$的集群中，随机选择$K$个磁盘命中某个副本放置策略的**组合数**$X$，除以所有可能的$K$个磁盘**组合数**$C_N^K$
$$
P_b(K) = \frac X {C_N^K}
$$
不同的数据复制方式，如多副本和EC；以及不同的副本放置策略，如固定位置和随机不重复放置，都会导致$X$的计算不同，以下对各类场景进行具体分析

### 符号定义

集群总数据量$M$，集群总磁盘数$N$，原始分片（还未做EC/复制）大小为$S$，损坏磁盘数量是$K$

多副本场景副本数为$R$，EC场景总分片数为$EC_n$，最多允许$EC_k - 1$片丢失

> 其中集群总数据量$M$可用类似如下模型计算得到：
> $$
> M = perC * N * Size \\
> perC为集群平均的单盘使用率，Size为单盘大小
> $$

### 随机不重复放置

1. $K = R$

   此时组合数$X$即为副本放置策略数量，因为副本放置策略不重复，每次选择的 $R$ 个磁盘都不同，因此只需计算共有多少次放置即为$X$
   
   **多副本场景**
   
   放置次数通过总数据量除$R$个副本占据的空间即可得到
   $$
   X = \frac M {T*R}
   $$
   **EC场景**
   
   放置次数通过总数据量除$EC_N$个分片占据的空间即可得到，这里需要根据EC策略计算一下原始分片放大比
   
   另外由于只需命中$EC_K$个分片即可造成数据丢失，因此还需乘一个系数$C_{EC_N}^{EC_K}$
   $$
   amplified = \frac {EC_N} {EC_N-EC_K+1} \\
   X = \frac M {T*S* amplified} * C_{EC_N}^{EC_K}
   $$
   其中$amplified$为EC的原始分片放大比


2. $K > R$

   此时组合数量计算就比较复杂，有时间拓展研究一下。

   另外如果$K>R$时，$P_a$很小可以忽略不计的话，则无需计算该情况下的$P_B$了

### 固定放置

1. $K = R$

   **多副本场景**
   
   在固定放置策略下，$R$个磁盘组成一个放置集合，彼此之间不相交，则有$N/R$种放置策略
   $$
   X = N / R
   $$
   **EC场景**
   
   在固定放置策略下，$EC_N$个磁盘组成了一个放置集合，彼此之间不相交，则有$N / EC_N$种放置策略
   
   另外由于只需命中$EC_K$个分片即可造成数据丢失，因此还需乘一个系数$C_{EC_N}^{EC_K}$
   $$
   X = \frac N {EC_N} * C_{EC_N}^{EC_K}
   $$
   
2. $K > R$

   此时组合数量计算就比较复杂，有时间拓展研究一下。

   另外如果$K>R$时，$P_a$很小可以忽略不计的话，则无需计算该情况下的$P_B$了

### 总结

副本放置策略本质上是**数据分散程度**（分散程度关系着并行恢复和访问的效率）和**数据丢失概率**的权衡

> 副本放置策略延伸阅读： *Ref[5]* 



## 代码实现



## Reference

1. [[blog] OceanBase 磁盘故障与存储系统的年失效率估算](http://oceanbase.org.cn/?p=151)
2. [[blog] 如何量化分布式存储系统的可靠性](https://zhuanlan.zhihu.com/p/47505443)
3. [[blog] Google’s Disk Failure Experience](https://storagemojo.com/2007/02/19/googles-disk-failure-experience/)
4. [[paper] Failure Trends in a Large Disk Drive Population](http://static.googleusercontent.com/media/research.google.com/en//archive/disk_failures.pdf)
5. [[paper] Copysets: Reducing the Frequency of Data Loss in Cloud Storage](https://web.stanford.edu/~skatti/pubs/usenix13-copysets.pdf)

