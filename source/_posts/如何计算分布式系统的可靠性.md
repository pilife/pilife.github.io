---
title: 如何计算分布式系统的可靠性
date: 2021-05-10 16:48:46
tags:
- 可靠性
- 概率论
categories:
- 概率论应用
mathjax: true
excerpt: 如果你熟悉各类云上存储产品，一定经常看到诸如数据可靠性11个9之类的描述，但是你可能不清楚这代表的具体含义，其单位是什么？是怎么计算出来的？本文将对分布式系统的可靠性计算作简要描述。
---

## 基础知识

泊松分布：描述**单位时间内**随机事件发生的**次数**的概率分布
$$
P(X=k)=\frac{e^{-\lambda}\lambda^k}{k!}
$$

## 问题建模

### 问题定义

简略描述：分布式存储系统年失效率

详细描述：以硬盘为存储数据的基本物理单位，一年时间内，硬盘故障导致数据丢失的概率

### 问题拆解

1. 单个硬盘单位时间故障概率 $\lambda$
2. `K`个硬盘一段时间`T`内故障概率 $P_a(T,K)$
3. 损坏的`K`个硬盘恰好造成数据丢失的概率 $P_b(K)$
4. `T`时间内，硬盘故障导致数据丢失的概率 $P_c(T)$

### 问题求解

####  $\lambda$

 $\lambda$通过统计即可得到，设为`t`的单位时间(设为1小时)内发生磁盘损坏的平均次数，根据google的统计，磁盘的年失败率(AFR: Fnnualized Failure Rate)如下图所示，我们取一个平均值4来进行计算，那么就是0.0004566

<img src="https://blog-1251491272.cos.ap-beijing.myqcloud.com/uPic/afr_age.png" style="zoom: 33%;" />

#### $P_a(T,K)$

通过 $\lambda$以及泊松分布的公式，可以计算得到$P_a(T,K)$

#### $P_b(K)$

通过数据复制方式和副本放置策略，可以建模得到 $P_b(K)$，数据复制方式分为多副本和EC，副本放置策略可以是固定位置放置，可以是随机不重复放置

> Q：关于随机不重复放置，是否能保证有足够的放置策略让副本放置不重复呢？
>
> A：随着集群规模增大，可容纳数据量呈线性增长，放置策略数量呈幂增长，因此可以认为放置策略远远大于需要放置的数据量（数据复制的基本单位是副本）
>
> 以下证明：
>
> 假设一个磁盘中副本数量为100，副本/EC数为N，集群中磁盘的数量为D
>
> 可容纳数据量：$D * 100 / N$
>
> 放置策略数量：$(D/N)^N$
>
> ![img](https://blog-1251491272.cos.ap-beijing.myqcloud.com/uPic/300px-Exponential.svg-20210510195955279.png)

### $P_c(T)$

通过$P_a(T,K)*P_b(K)$可以得到`T`时间内损坏磁盘数量为`K`时，数据丢失的概率。将所有可能的`K`计算得到的概率相加即可得到$P_c(T)$，计算公式如下：
$$
\sum P_a(T,K)*P_b(K) \\
K \ge min\ number\ of\ replica\ to\ be\ removed
$$


## 细节补充

通过对问题进行建模，发现唯一不确定的地方就是$P_b(K)$的计算，不同的数据复制方式，如多副本和EC；以及不同的副本放置策略，如固定位置和随机不重复放置，都会导致$P_b(K)$的计算不同，以下对各类场景进行具体分析

### 多副本场景



### EC场景



## 代码实现



## Reference

1. [[blog] OceanBase 磁盘故障与存储系统的年失效率估算](http://oceanbase.org.cn/?p=151)
2. [[blog] 如何量化分布式存储系统的可靠性](https://zhuanlan.zhihu.com/p/47505443)
3. [[blog] Google’s Disk Failure Experience](https://storagemojo.com/2007/02/19/googles-disk-failure-experience/)
4. [[paper] Failure Trends in a Large Disk Drive Population](http://static.googleusercontent.com/media/research.google.com/en//archive/disk_failures.pdf)

